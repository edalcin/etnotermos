<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | EtnoTermos Admin</title>
  <link href="/assets/styles.css?v=<%= Date.now() %>" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
</head>
<body class="bg-forest-50 min-h-screen flex flex-col">
  <%- include('partials/header') %>
  <main class="flex-grow container mx-auto px-4 py-8">

<div x-data="{
  relationships: [],
  loading: true,
  page: 1,
  totalPages: 1,
  typeFilter: '',
  async init() {
    await this.loadRelationships();
  },
  async loadRelationships() {
    this.loading = true;
    try {
      const params = new URLSearchParams({
        page: this.page,
        limit: 20,
        ...(this.typeFilter && { type: this.typeFilter })
      });

      const response = await fetch(`/api/v1/admin/relationships?${params}`);
      const data = await response.json();
      this.relationships = data.data || [];
      this.totalPages = data.pagination?.totalPages || 1;
    } catch (error) {
      console.error('Error loading relationships:', error);
    } finally {
      this.loading = false;
    }
  },
  async deleteRelationship(id) {
    if (!confirm('Tem certeza que deseja excluir este relacionamento? O relacionamento recíproco também será excluído.')) return;

    try {
      const response = await fetch(`/api/v1/admin/relationships/${id}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        await this.loadRelationships();
        alert('Relacionamento excluído com sucesso!');
      } else {
        alert('Erro ao excluir relacionamento.');
      }
    } catch (error) {
      console.error('Error deleting relationship:', error);
      alert('Erro ao excluir relacionamento.');
    }
  },
  getBadgeColor(type) {
    // Equivalence
    if (type === 'USE' || type === 'UF') return 'bg-green-100 text-green-800';
    // Hierarchical
    if (['BT', 'NT', 'BTG', 'NTG', 'BTP', 'NTP', 'BTI', 'NTI'].includes(type)) return 'bg-blue-100 text-blue-700';
    // Associative
    if (type === 'RT') return 'bg-gray-100 text-gray-700';
    return 'bg-gray-100 text-gray-700';
  },
  formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('pt-BR');
  },
  nextPage() {
    if (this.page < this.totalPages) {
      this.page++;
      this.loadRelationships();
    }
  },
  prevPage() {
    if (this.page > 1) {
      this.page--;
      this.loadRelationships();
    }
  }
}">

  <!-- Header and Actions -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold text-forest-700">Gerenciar Relacionamentos</h1>
      <p class="text-gray-600 mt-1">Administração de relacionamentos semânticos entre termos</p>
    </div>
    <a href="/relationships/new" class="px-6 py-3 bg-forest-600 text-white rounded-lg hover:bg-forest-700 transition-colors font-medium">
      + Novo Relacionamento
    </a>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-lg shadow-md p-4 mb-6">
    <div class="flex gap-4 items-end">
      <div class="flex-1">
        <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Tipo</label>
        <select
          x-model="typeFilter"
          @change="page = 1; loadRelationships()"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
        >
          <option value="">Todos os tipos</option>
          <optgroup label="Equivalência">
            <option value="USE">USE - Aponta de termo não-preferido para termo preferido</option>
            <option value="UF">UF - Usado Para</option>
          </optgroup>
          <optgroup label="Hierárquico">
            <option value="BT">BT - Termo Genérico</option>
            <option value="NT">NT - Termo Específico</option>
            <option value="BTG">BTG - Termo Genérico Genérico</option>
            <option value="NTG">NTG - Termo Específico Genérico</option>
            <option value="BTP">BTP - Termo Genérico Partitivo</option>
            <option value="NTP">NTP - Termo Específico Partitivo</option>
            <option value="BTI">BTI - Termo Genérico de Instância</option>
            <option value="NTI">NTI - Termo Específico de Instância</option>
          </optgroup>
          <optgroup label="Associativo">
            <option value="RT">RT - Termo Relacionado</option>
          </optgroup>
        </select>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div x-show="loading" class="bg-white rounded-lg shadow-md p-8 text-center">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-forest-600"></div>
    <p class="text-gray-600 mt-3">Carregando relacionamentos...</p>
  </div>

  <!-- Empty State -->
  <div x-show="!loading && relationships.length === 0" class="bg-white rounded-lg shadow-md p-8 text-center">
    <p class="text-gray-600">Nenhum relacionamento encontrado.</p>
    <a href="/relationships/new" class="inline-block mt-4 px-6 py-3 bg-forest-600 text-white rounded-lg hover:bg-forest-700 transition-colors">
      Criar Primeiro Relacionamento
    </a>
  </div>

  <!-- Table -->
  <div x-show="!loading && relationships.length > 0" class="bg-white rounded-lg shadow-md overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-forest-600">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
            Termo de Origem
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
            Tipo
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
            Termo de Destino
          </th>
          <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">
            Data
          </th>
          <th class="px-6 py-3 text-right text-xs font-medium text-white uppercase tracking-wider">
            Ações
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <template x-for="rel in relationships" :key="rel._id">
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">
              <div class="text-sm font-medium text-gray-900" x-text="rel.sourceTerm?.prefLabel || 'Termo não encontrado'"></div>
              <div class="text-xs text-gray-500" x-text="rel.sourceTermId"></div>
            </td>
            <td class="px-6 py-4">
              <span
                class="px-3 py-1 rounded-full text-sm font-medium"
                :class="getBadgeColor(rel.type)"
                x-text="rel.type"
              ></span>
            </td>
            <td class="px-6 py-4">
              <div class="text-sm font-medium text-gray-900" x-text="rel.targetTerm?.prefLabel || 'Termo não encontrado'"></div>
              <div class="text-xs text-gray-500" x-text="rel.targetTermId"></div>
            </td>
            <td class="px-6 py-4 text-sm text-gray-500">
              <span x-text="formatDate(rel.createdAt)"></span>
            </td>
            <td class="px-6 py-4 text-right text-sm font-medium">
              <button
                @click="deleteRelationship(rel._id)"
                class="text-red-600 hover:text-red-900"
              >
                Excluir
              </button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="bg-gray-50 px-6 py-3 flex items-center justify-between border-t border-gray-200">
      <div class="text-sm text-gray-700">
        Página <span x-text="page"></span> de <span x-text="totalPages"></span>
      </div>
      <div class="flex gap-2">
        <button
          @click="prevPage()"
          :disabled="page === 1"
          class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:bg-gray-100 disabled:cursor-not-allowed"
        >
          Anterior
        </button>
        <button
          @click="nextPage()"
          :disabled="page === totalPages"
          class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:bg-gray-100 disabled:cursor-not-allowed"
        >
          Próxima
        </button>
      </div>
    </div>
  </div>

</div>

  </main>
  <%- include('partials/footer') %>
</body>
</html>
