<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | EtnoTermos Admin</title>
  <link href="/assets/styles.css?v=<%= Date.now() %>" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
</head>
<body class="bg-forest-50 min-h-screen flex flex-col">
  <%- include('partials/header') %>
  <main class="flex-grow container mx-auto px-4 py-8">

<div x-data="{
  isEdit: <%= isEdit ? 'true' : 'false' %>,
  collectionId: '<%= collectionId || '' %>',
  form: {
    name: '',
    description: ''
  },
  loading: true,
  saving: false,
  activeTooltip: null,
  toggleTooltip(id) {
    this.activeTooltip = this.activeTooltip === id ? null : id;
  },
  async init() {
    if (this.isEdit) {
      await this.loadCollection();
    }
    this.loading = false;
  },
  async loadCollection() {
    try {
      const response = await fetch(`/api/v1/collections/${this.collectionId}`);
      const collection = await response.json();
      this.form = {
        name: collection.name || '',
        description: collection.description || ''
      };
    } catch (error) {
      console.error('Error loading collection:', error);
      alert('Erro ao carregar coleção.');
    }
  },
  async saveCollection() {
    // Validation
    if (!this.form.name.trim()) {
      alert('O nome da coleção é obrigatório.');
      return;
    }

    if (this.form.name.length > 200) {
      alert('O nome da coleção deve ter no máximo 200 caracteres.');
      return;
    }

    this.saving = true;
    try {
      const url = this.isEdit
        ? `/api/v1/collections/${this.collectionId}`
        : '/api/v1/collections';

      const method = this.isEdit ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(this.form)
      });

      if (response.ok) {
        alert(this.isEdit ? 'Coleção atualizada com sucesso!' : 'Coleção criada com sucesso!');
        window.location.href = '/collections';
      } else {
        const error = await response.json();
        alert('Erro ao salvar coleção: ' + (error.error || 'Erro desconhecido'));
      }
    } catch (error) {
      console.error('Error saving collection:', error);
      alert('Erro ao salvar coleção.');
    } finally {
      this.saving = false;
    }
  }
}">

  <!-- Loading State -->
  <div x-show="loading" class="flex justify-center items-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-forest-600"></div>
    <span class="ml-3 text-gray-600">Carregando...</span>
  </div>

  <!-- Form -->
  <div x-show="!loading">
    <!-- Header -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <h1 class="text-3xl font-bold text-forest-700" x-text="isEdit ? 'Editar Coleção' : 'Nova Coleção'"></h1>
        <a href="/collections" class="text-gray-600 hover:text-gray-800">← Voltar</a>
      </div>
    </div>

    <!-- Form Card -->
    <div class="bg-white rounded-lg shadow-md p-6 max-w-2xl">
      <!-- Name Field -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
          Nome da Coleção *
          <div class="relative inline-block">
            <button
              type="button"
              @click.stop="toggleTooltip('name')"
              class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
            >
              <span class="text-xs font-bold">i</span>
            </button>
            <div
              x-show="activeTooltip === 'name'"
              @click.away="activeTooltip = null"
              class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
              style="display: none;"
            >
              <h4 class="font-semibold text-gray-900 mb-1">Nome da Coleção</h4>
              <p class="text-gray-700 mb-2">
                Nome descritivo para o agrupamento temático. Use convenções de nomenclatura claras e concisas. O nome deve ser único no vocabulário.
              </p>
              <p class="text-xs text-gray-600 italic">
                <strong>Exemplo:</strong> "Plantas Medicinais Amazônicas", "Usos Cerimoniais", "Raízes Comestíveis"
              </p>
            </div>
          </div>
        </label>
        <input
          type="text"
          x-model="form.name"
          placeholder="Ex: Plantas Medicinais Amazônicas"
          maxlength="200"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
        />
        <p class="text-xs text-gray-500 mt-1">
          <span x-text="form.name.length"></span>/200 caracteres
        </p>
      </div>

      <!-- Description Field -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
          Descrição (opcional)
          <div class="relative inline-block">
            <button
              type="button"
              @click.stop="toggleTooltip('description')"
              class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
            >
              <span class="text-xs font-bold">i</span>
            </button>
            <div
              x-show="activeTooltip === 'description'"
              @click.away="activeTooltip = null"
              class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
              style="display: none;"
            >
              <h4 class="font-semibold text-gray-900 mb-1">Descrição</h4>
              <p class="text-gray-700 mb-2">
                Explique o critério de agrupamento e o propósito desta coleção. Ajuda usuários a entenderem quando adicionar termos a esta coleção.
              </p>
              <p class="text-xs text-gray-600 italic">
                <strong>Exemplo:</strong> "Reúne plantas utilizadas por comunidades tradicionais da Amazônia para fins medicinais, documentando conhecimento etnobotânico regional."
              </p>
            </div>
          </div>
        </label>
        <textarea
          x-model="form.description"
          rows="4"
          placeholder="Descreva o propósito e critérios desta coleção..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
        ></textarea>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-4">
        <button
          type="button"
          @click="saveCollection()"
          :disabled="saving"
          class="px-6 py-3 bg-forest-600 text-white rounded-lg hover:bg-forest-700 transition-colors font-medium disabled:bg-gray-400 disabled:cursor-not-allowed"
        >
          <span x-show="!saving" x-text="isEdit ? 'Atualizar Coleção' : 'Criar Coleção'"></span>
          <span x-show="saving">Salvando...</span>
        </button>
        <a
          href="/collections"
          class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors inline-block"
        >
          Cancelar
        </a>
      </div>
    </div>
  </div>

</div>

  </main>
  <%- include('partials/footer') %>
</body>
</html>
