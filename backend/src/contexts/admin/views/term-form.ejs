<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | EtnoTermos Admin</title>
  <link href="/assets/styles.css" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
</head>
<body class="bg-forest-50 min-h-screen flex flex-col">
  <%- include('partials/header') %>
  <main class="flex-grow container mx-auto px-4 py-8">

<div x-data="{
  isEdit: <%= isEdit ? 'true' : 'false' %>,
  termId: '<%= termId || '' %>',
  form: {
    prefLabel: '',
    altLabels: [],
    definition: '',
    scopeNote: '',
    example: '',
    language: 'pt-BR',
    status: 'active',
    collections: []
  },
  altLabelInput: '',
  collections: [],
  loading: true,
  saving: false,
  async init() {
    await this.loadCollections();
    if (this.isEdit) {
      await this.loadTerm();
    }
    this.loading = false;
  },
  async loadCollections() {
    try {
      const response = await fetch('/api/v1/collections');
      this.collections = await response.json();
    } catch (error) {
      console.error('Error loading collections:', error);
    }
  },
  async loadTerm() {
    try {
      const response = await fetch(`/api/v1/admin/terms/${this.termId}`);
      const term = await response.json();
      this.form = {
        prefLabel: term.prefLabel || '',
        altLabels: term.altLabels || [],
        definition: term.definition || '',
        scopeNote: term.scopeNote || '',
        example: term.example || '',
        language: term.language || 'pt-BR',
        status: term.status || 'active',
        collections: term.collections || []
      };
    } catch (error) {
      console.error('Error loading term:', error);
      alert('Erro ao carregar termo.');
    }
  },
  addAltLabel() {
    if (this.altLabelInput.trim()) {
      this.form.altLabels.push(this.altLabelInput.trim());
      this.altLabelInput = '';
    }
  },
  removeAltLabel(index) {
    this.form.altLabels.splice(index, 1);
  },
  toggleCollection(collectionId) {
    const index = this.form.collections.indexOf(collectionId);
    if (index > -1) {
      this.form.collections.splice(index, 1);
    } else {
      this.form.collections.push(collectionId);
    }
  },
  async saveTerm() {
    // Validation
    if (!this.form.prefLabel.trim()) {
      alert('O termo preferencial é obrigatório.');
      return;
    }

    this.saving = true;
    try {
      const url = this.isEdit
        ? `/api/v1/admin/terms/${this.termId}`
        : '/api/v1/admin/terms';

      const method = this.isEdit ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(this.form)
      });

      if (response.ok) {
        alert(this.isEdit ? 'Termo atualizado com sucesso!' : 'Termo criado com sucesso!');
        window.location.href = '/terms';
      } else {
        const error = await response.json();
        alert(`Erro: ${error.error?.message || 'Erro ao salvar termo'}`);
      }
    } catch (error) {
      console.error('Error saving term:', error);
      alert('Erro ao salvar termo.');
    } finally {
      this.saving = false;
    }
  }
}">

  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-2">
      <h1 class="text-3xl font-bold text-forest-700" x-text="isEdit ? 'Editar Termo' : 'Novo Termo'"></h1>
      <a href="/terms" class="text-gray-600 hover:text-gray-800">← Voltar para lista</a>
    </div>
    <p class="text-gray-600">Preencha os campos seguindo o padrão ANSI/NISO Z39.19-2005</p>
  </div>

  <!-- Loading State -->
  <div x-show="loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-forest-600"></div>
    <p class="text-gray-600 mt-4">Carregando...</p>
  </div>

  <!-- Form -->
  <form x-show="!loading" @submit.prevent="saveTerm()" class="space-y-6">
    <!-- Basic Information -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Informações Básicas</h2>

      <div class="space-y-4">
        <!-- Preferred Label -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Termo Preferencial (PT) *
          </label>
          <input
            type="text"
            x-model="form.prefLabel"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            placeholder="Ex: Planta Medicinal"
          >
          <p class="text-xs text-gray-500 mt-1">
            A forma autorizada e preferencial do conceito
          </p>
        </div>

        <!-- Alternative Labels -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Termos Alternativos (USE/UF)
          </label>
          <div class="flex gap-2 mb-2">
            <input
              type="text"
              x-model="altLabelInput"
              @keyup.enter="addAltLabel()"
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
              placeholder="Digite um termo alternativo e pressione Enter"
            >
            <button
              type="button"
              @click="addAltLabel()"
              class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:bg-forest-700"
            >
              Adicionar
            </button>
          </div>
          <div x-show="form.altLabels.length > 0" class="flex flex-wrap gap-2">
            <template x-for="(label, index) in form.altLabels" :key="index">
              <span class="inline-flex items-center gap-2 px-3 py-1 bg-forest-50 text-forest-700 rounded-full text-sm">
                <span x-text="label"></span>
                <button
                  type="button"
                  @click="removeAltLabel(index)"
                  class="text-forest-600 hover:text-forest-800"
                >
                  ×
                </button>
              </span>
            </template>
          </div>
          <p class="text-xs text-gray-500 mt-1">
            Sinônimos, variações ortográficas e formas não-preferenciais
          </p>
        </div>

        <!-- Language and Status -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Idioma
            </label>
            <select
              x-model="form.language"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            >
              <option value="pt-BR">Português (Brasil)</option>
              <option value="en">English</option>
              <option value="es">Español</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Status
            </label>
            <select
              x-model="form.status"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            >
              <option value="active">Ativo</option>
              <option value="candidate">Candidato</option>
              <option value="deprecated">Depreciado</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Definition and Notes -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Definição e Notas</h2>

      <div class="space-y-4">
        <!-- Definition -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Definição
          </label>
          <textarea
            x-model="form.definition"
            rows="4"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            placeholder="Definição clara e concisa do conceito..."
          ></textarea>
          <p class="text-xs text-gray-500 mt-1">
            Explicação do significado do termo de forma clara e objetiva
          </p>
        </div>

        <!-- Scope Note -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Nota de Escopo
          </label>
          <textarea
            x-model="form.scopeNote"
            rows="3"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            placeholder="Delimite o uso e aplicação do termo..."
          ></textarea>
          <p class="text-xs text-gray-500 mt-1">
            Informações sobre o contexto de uso e limitações do termo
          </p>
        </div>

        <!-- Example -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Exemplo de Uso
          </label>
          <textarea
            x-model="form.example"
            rows="2"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            placeholder="Exemplo prático de uso do termo..."
          ></textarea>
          <p class="text-xs text-gray-500 mt-1">
            Exemplo contextual que ilustra o uso correto do termo
          </p>
        </div>
      </div>
    </div>

    <!-- Collections -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Coleções</h2>

      <div x-show="collections.length === 0" class="text-gray-600">
        Nenhuma coleção disponível
      </div>

      <div x-show="collections.length > 0" class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <template x-for="collection in collections" :key="collection._id">
          <label class="flex items-center space-x-2 cursor-pointer p-3 border rounded-lg hover:bg-gray-50">
            <input
              type="checkbox"
              :value="collection._id"
              :checked="form.collections.includes(collection._id)"
              @change="toggleCollection(collection._id)"
              class="rounded text-forest-600 focus:ring-forest-500"
            >
            <span class="text-sm text-gray-700" x-text="collection.name"></span>
          </label>
        </template>
      </div>
      <p class="text-xs text-gray-500 mt-4">
        Associe este termo a coleções temáticas para facilitar a organização
      </p>
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-between bg-white rounded-lg shadow-md p-6">
      <a
        href="/terms"
        class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium"
      >
        Cancelar
      </a>

      <button
        type="submit"
        :disabled="saving"
        :class="saving ? 'bg-gray-400 cursor-not-allowed' : 'bg-forest-600 hover:bg-forest-700'"
        class="px-8 py-3 text-white rounded-lg transition-colors font-medium flex items-center gap-2"
      >
        <div x-show="saving" class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
        <span x-text="saving ? 'Salvando...' : (isEdit ? 'Atualizar Termo' : 'Criar Termo')"></span>
      </button>
    </div>
  </form>
</div>

  </main>
  <%- include('partials/footer') %>
</body>
</html>
