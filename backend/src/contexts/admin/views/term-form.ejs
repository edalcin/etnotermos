<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | EtnoTermos Admin</title>
  <link href="/assets/styles.css?v=<%= Date.now() %>" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
</head>
<body class="bg-forest-50 min-h-screen flex flex-col">
  <%- include('partials/header') %>
  <main class="flex-grow container mx-auto px-4 py-8">

<div x-data="{
  isEdit: <%= isEdit ? 'true' : 'false' %>,
  termId: '<%= termId || '' %>',
  form: {
    prefLabel: '',
    altLabels: [],
    definition: '',
    scopeNote: '',
    example: '',
    status: 'candidate',
    termType: 'preferred',
    collectionIds: []
  },
  isPreferredTerm: true,
  altLabelInput: '',
  collections: [],
  loading: true,
  saving: false,
  activeTooltip: null,
  toggleTooltip(id) {
    this.activeTooltip = this.activeTooltip === id ? null : id;
  },
  async init() {
    await this.loadCollections();
    if (this.isEdit) {
      await this.loadTerm();
    }
    this.loading = false;
  },
  async loadCollections() {
    try {
      const response = await fetch('/api/v1/collections');
      this.collections = await response.json();
    } catch (error) {
      console.error('Error loading collections:', error);
    }
  },
  async loadTerm() {
    try {
      const response = await fetch(`/api/v1/admin/terms/${this.termId}`);
      const term = await response.json();
      this.form = {
        prefLabel: term.prefLabel || '',
        altLabels: term.altLabels || [],
        definition: term.definition || '',
        scopeNote: term.scopeNote || '',
        example: term.example || '',
        language: term.language || 'pt-BR',
        status: term.status || 'candidate',
        termType: term.termType || 'preferred',
        collectionIds: (term.collectionIds || []).map(id => id.toString())
      };
      this.isPreferredTerm = this.form.termType === 'preferred';
    } catch (error) {
      console.error('Error loading term:', error);
      alert('Erro ao carregar termo.');
    }
  },
  addAltLabel() {
    if (this.altLabelInput.trim()) {
      this.form.altLabels.push(this.altLabelInput.trim());
      this.altLabelInput = '';
    }
  },
  removeAltLabel(index) {
    this.form.altLabels.splice(index, 1);
  },
  toggleCollection(collectionId) {
    const index = this.form.collectionIds.indexOf(collectionId);
    if (index > -1) {
      this.form.collectionIds.splice(index, 1);
    } else {
      this.form.collectionIds.push(collectionId);
    }
  },
  async saveTerm() {
    // Validation
    if (!this.form.prefLabel.trim()) {
      alert('O termo é obrigatório.');
      return;
    }

    // Set termType based on checkbox
    this.form.termType = this.isPreferredTerm ? 'preferred' : 'entry';

    // For new terms, always use 'candidate' status
    if (!this.isEdit) {
      this.form.status = 'candidate';
    }

    this.saving = true;
    try {
      const url = this.isEdit
        ? `/api/v1/admin/terms/${this.termId}`
        : '/api/v1/admin/terms';

      const method = this.isEdit ? 'PUT' : 'POST';

      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(this.form)
      });

      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);

      if (response.ok) {
        alert(this.isEdit ? 'Termo atualizado com sucesso!' : 'Termo criado com sucesso!');
        window.location.href = '/terms';
      } else {
        const errorText = await response.text();
        console.error('Error response text:', errorText);

        let errorMessage = 'Erro ao salvar termo';
        try {
          const errorJson = JSON.parse(errorText);
          console.error('Error response JSON:', errorJson);

          // Extract error message from various possible structures
          if (typeof errorJson.error === 'string') {
            errorMessage = errorJson.error;
          } else if (errorJson.error && errorJson.error.message) {
            errorMessage = errorJson.error.message;
          } else if (errorJson.error && typeof errorJson.error === 'object') {
            errorMessage = JSON.stringify(errorJson.error);
          } else if (errorJson.message) {
            errorMessage = errorJson.message;
          }

          console.error('Extracted error message:', errorMessage);
        } catch (e) {
          console.error('Could not parse error as JSON:', e);
          errorMessage = errorText || errorMessage;
        }

        alert('Erro: ' + errorMessage);
      }
    } catch (error) {
      console.error('Error saving term:', error);
      alert('Erro ao salvar termo: ' + error.message);
    } finally {
      this.saving = false;
    }
  }
}">

  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-2">
      <h1 class="text-3xl font-bold text-forest-700" x-text="isEdit ? 'Editar Termo' : 'Novo Termo'"></h1>
      <a href="/terms" class="text-gray-600 hover:text-gray-800">← Voltar para lista</a>
    </div>
    <p class="text-gray-600">Preencha os campos seguindo o padrão ANSI/NISO Z39.19-2005</p>
  </div>

  <!-- Loading State -->
  <div x-show="loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-forest-600"></div>
    <p class="text-gray-600 mt-4">Carregando...</p>
  </div>

  <!-- Form -->
  <form x-show="!loading" @submit.prevent="saveTerm()" class="space-y-6">
    <!-- Basic Information -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Informações Básicas</h2>

      <div class="space-y-4">
        <!-- Term Label -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
            Novo Termo *
            <div class="relative inline-block">
              <button
                type="button"
                @click.stop="toggleTooltip('prefLabel')"
                class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
              >
                <span class="text-xs font-bold">i</span>
              </button>
              <div
                x-show="activeTooltip === 'prefLabel'"
                @click.away="activeTooltip = null"
                class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
                style="display: none;"
              >
                <h4 class="font-semibold text-gray-900 mb-1">Novo Termo</h4>
                <p class="text-gray-700 mb-2">
                  O termo a ser cadastrado seguindo ANSI/NISO Z39.19. Use substantivos no singular para conceitos (ex: "planta", "raiz") e plural para itens contáveis (ex: "sementes", "folhas").
                </p>
                <p class="text-xs text-gray-600 italic">
                  <strong>Exemplo:</strong> "Ayahuasca", "Mandioca", "Cannabis"
                </p>
              </div>
            </div>
          </label>
          <input
            type="text"
            x-model="form.prefLabel"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            placeholder="Ex: Ayahuasca"
          >
        </div>

        <!-- Is Preferred Term Checkbox -->
        <div class="flex items-start gap-3 p-4 bg-forest-50 rounded-lg border border-forest-200">
          <input
            type="checkbox"
            id="isPreferredTerm"
            x-model="isPreferredTerm"
            class="mt-1 h-5 w-5 rounded text-forest-600 focus:ring-forest-500 border-gray-300"
          >
          <div>
            <label for="isPreferredTerm" class="text-sm font-medium text-gray-700 cursor-pointer flex items-center gap-2">
              Termo Preferencial
              <div class="relative inline-block">
                <button
                  type="button"
                  @click.stop="toggleTooltip('isPreferred')"
                  class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
                >
                  <span class="text-xs font-bold">i</span>
                </button>
                <div
                  x-show="activeTooltip === 'isPreferred'"
                  @click.away="activeTooltip = null"
                  class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
                  style="display: none;"
                >
                  <h4 class="font-semibold text-gray-900 mb-1">Termo Preferencial</h4>
                  <p class="text-gray-700 mb-2">
                    <strong>Marcado:</strong> Este termo representa um conceito principal e sera a forma autorizada de referencia. Um novo conceito sera criado para este termo.
                  </p>
                  <p class="text-gray-700 mb-2">
                    <strong>Desmarcado:</strong> Este e um termo de entrada (sinonimo, variante) que podera ser associado a um Termo Preferencial existente atraves de relacoes USE/UF.
                  </p>
                  <p class="text-xs text-gray-600 italic">
                    <strong>Exemplo:</strong> "Ayahuasca" (preferencial) vs "Daime", "Yage" (termos de entrada)
                  </p>
                </div>
              </div>
            </label>
            <p class="text-xs text-gray-500 mt-1">
              Marque se este termo representa um conceito principal. Desmarque para termos alternativos/sinonimos.
            </p>
          </div>
        </div>

        <!-- Alternative Labels -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
            Termos Alternativos (USE/UF)
            <div class="relative inline-block">
              <button
                type="button"
                @click.stop="toggleTooltip('altLabels')"
                class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
              >
                <span class="text-xs font-bold">i</span>
              </button>
              <div
                x-show="activeTooltip === 'altLabels'"
                @click.away="activeTooltip = null"
                class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
                style="display: none;"
              >
                <h4 class="font-semibold text-gray-900 mb-1">Termos Alternativos</h4>
                <p class="text-gray-700 mb-2">
                  Sinônimos, variantes ortográficas, nomes comuns vs. científicos, terminologia popular vs. técnica. Estabelecem relações de equivalência USE/UF.
                </p>
                <p class="text-xs text-gray-600 italic">
                  <strong>Exemplo:</strong> Para "Cassava" adicionar: "Mandioca", "Manioc", "Yuca", "Manihot esculenta"
                </p>
              </div>
            </div>
          </label>
          <div class="flex gap-2 mb-2">
            <input
              type="text"
              x-model="altLabelInput"
              @keyup.enter="addAltLabel()"
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
              placeholder="Digite um termo alternativo e pressione Enter"
            >
            <button
              type="button"
              @click="addAltLabel()"
              class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:bg-forest-700"
            >
              Adicionar
            </button>
          </div>
          <div x-show="form.altLabels.length > 0" class="flex flex-wrap gap-2">
            <template x-for="(label, index) in form.altLabels" :key="index">
              <span class="inline-flex items-center gap-2 px-3 py-1 bg-forest-50 text-forest-700 rounded-full text-sm">
                <span x-text="label"></span>
                <button
                  type="button"
                  @click="removeAltLabel(index)"
                  class="text-forest-600 hover:text-forest-800"
                >
                  ×
                </button>
              </span>
            </template>
          </div>
        </div>

        <!-- Language and Status -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
              Idioma
              <div class="relative inline-block">
                <button
                  type="button"
                  @click.stop="toggleTooltip('language')"
                  class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
                >
                  <span class="text-xs font-bold">i</span>
                </button>
                <div
                  x-show="activeTooltip === 'language'"
                  @click.away="activeTooltip = null"
                  class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
                  style="display: none;"
                >
                  <h4 class="font-semibold text-gray-900 mb-1">Idioma</h4>
                  <p class="text-gray-700 mb-2">
                    Idioma principal do termo. Para termos em línguas indígenas, documente com guias de pronúncia quando possível e respeite preferências de nomenclatura dos detentores de conhecimento.
                  </p>
                  <p class="text-xs text-gray-600 italic">
                    <strong>Exemplo:</strong> Termos Tupi-Guarani podem ser registrados com pronúncia aproximada
                  </p>
                </div>
              </div>
            </label>
            <select
              x-model="form.language"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            >
              <option value="pt-BR">Português (Brasil)</option>
              <option value="en">English</option>
              <option value="es">Español</option>
            </select>
          </div>

          <!-- Status dropdown - only visible in edit mode -->
          <div x-show="isEdit">
            <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
              Status
              <div class="relative inline-block">
                <button
                  type="button"
                  @click.stop="toggleTooltip('status')"
                  class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
                >
                  <span class="text-xs font-bold">i</span>
                </button>
                <div
                  x-show="activeTooltip === 'status'"
                  @click.away="activeTooltip = null"
                  class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl right-0"
                  style="display: none;"
                >
                  <h4 class="font-semibold text-gray-900 mb-1">Status do Termo</h4>
                  <p class="text-gray-700 mb-2">
                    <strong>Candidato:</strong> Sob revisão para inclusão.<br>
                    <strong>Ativo:</strong> Termo aprovado e em uso.<br>
                    <strong>Depreciado:</strong> Não mais usado, substituído por outro.
                  </p>
                  <p class="text-xs text-gray-600 italic">
                    <strong>Exemplo:</strong> "Cânhamo indiano" (depreciado) → "Cannabis" (ativo)
                  </p>
                </div>
              </div>
            </label>
            <select
              x-model="form.status"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            >
              <option value="active">Ativo</option>
              <option value="candidate">Candidato</option>
              <option value="deprecated">Depreciado</option>
            </select>
          </div>

          <!-- Status info for new terms -->
          <div x-show="!isEdit" class="flex items-center">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 w-full">
              <p class="text-sm text-yellow-800">
                <strong>Status:</strong> Novos termos entram automaticamente como <span class="font-semibold">Candidato</span> para revisão.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Definition and Notes -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Definição e Notas</h2>

      <div class="space-y-4">
        <!-- Definition -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
            Definição
            <div class="relative inline-block">
              <button
                type="button"
                @click.stop="toggleTooltip('definition')"
                class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
              >
                <span class="text-xs font-bold">i</span>
              </button>
              <div
                x-show="activeTooltip === 'definition'"
                @click.away="activeTooltip = null"
                class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
                style="display: none;"
              >
                <h4 class="font-semibold text-gray-900 mb-1">Definição</h4>
                <p class="text-gray-700 mb-2">
                  Definição formal e científica do conceito. Seja preciso e objetivo, evitando ambiguidades.
                </p>
                <p class="text-xs text-gray-600 italic">
                  <strong>Exemplo:</strong> "Etnobotânica: O estudo científico do conhecimento e costumes tradicionais de povos em relação às plantas e seus usos medicinais, religiosos e outros."
                </p>
              </div>
            </div>
          </label>
          <textarea
            x-model="form.definition"
            rows="4"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            placeholder="Definição clara e concisa do conceito..."
          ></textarea>
        </div>

        <!-- Scope Note -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
            Nota de Escopo
            <div class="relative inline-block">
              <button
                type="button"
                @click.stop="toggleTooltip('scopeNote')"
                class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
              >
                <span class="text-xs font-bold">i</span>
              </button>
              <div
                x-show="activeTooltip === 'scopeNote'"
                @click.away="activeTooltip = null"
                class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
                style="display: none;"
              >
                <h4 class="font-semibold text-gray-900 mb-1">Nota de Escopo</h4>
                <p class="text-gray-700 mb-2">
                  Define limites e contexto de uso do termo. Esclareça quando usar ou não usar este termo, diferenciando de conceitos similares.
                </p>
                <p class="text-xs text-gray-600 italic">
                  <strong>Exemplo:</strong> "Ayahuasca: Refere-se tanto à bebida psicoativa quanto ao contexto cerimonial de uso. Para as espécies vegetais, veja Banisteriopsis caapi e Psychotria viridis."
                </p>
              </div>
            </div>
          </label>
          <textarea
            x-model="form.scopeNote"
            rows="3"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            placeholder="Delimite o uso e aplicação do termo..."
          ></textarea>
        </div>

        <!-- Example -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
            Exemplo de Uso
            <div class="relative inline-block">
              <button
                type="button"
                @click.stop="toggleTooltip('example')"
                class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
              >
                <span class="text-xs font-bold">i</span>
              </button>
              <div
                x-show="activeTooltip === 'example'"
                @click.away="activeTooltip = null"
                class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
                style="display: none;"
              >
                <h4 class="font-semibold text-gray-900 mb-1">Exemplo de Uso</h4>
                <p class="text-gray-700 mb-2">
                  Ilustre o uso do termo em contexto prático com exemplos reais de comunidades tradicionais ou pesquisas etnobotânicas.
                </p>
                <p class="text-xs text-gray-600 italic">
                  <strong>Exemplo:</strong> "A comunidade Guarani utiliza a casca do ipê-roxo em decocção para tratamento de inflamações."
                </p>
              </div>
            </div>
          </label>
          <textarea
            x-model="form.example"
            rows="2"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            placeholder="Exemplo prático de uso do termo..."
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Collections -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
        Coleções
        <div class="relative inline-block">
          <button
            type="button"
            @click.stop="toggleTooltip('collections')"
            class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
          >
            <span class="text-xs font-bold">i</span>
          </button>
          <div
            x-show="activeTooltip === 'collections'"
            @click.away="activeTooltip = null"
            class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
            style="display: none;"
          >
            <h4 class="font-semibold text-gray-900 mb-1">Coleções</h4>
            <p class="text-gray-700 mb-2">
              Agrupamentos temáticos para organizar o vocabulário. Um termo pode pertencer a múltiplas coleções.
            </p>
            <p class="text-xs text-gray-600 italic">
              <strong>Exemplo:</strong> "Alho" pode estar em "Plantas Medicinais", "Plantas Alimentícias" e "Plantas Antimicrobianas"
            </p>
          </div>
        </div>
      </h2>

      <div x-show="collections.length === 0" class="text-gray-600">
        Nenhuma coleção disponível
      </div>

      <div x-show="collections.length > 0" class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <template x-for="collection in collections" :key="collection._id">
          <label class="flex items-center space-x-2 cursor-pointer p-3 border rounded-lg hover:bg-gray-50">
            <input
              type="checkbox"
              :value="collection._id"
              :checked="form.collectionIds.includes(collection._id)"
              @change="toggleCollection(collection._id)"
              class="rounded text-forest-600 focus:ring-forest-500"
            >
            <span class="text-sm text-gray-700" x-text="collection.name"></span>
          </label>
        </template>
      </div>
      <p class="text-xs text-gray-500 mt-4">
        Associe este termo a coleções temáticas para facilitar a organização
      </p>
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-between bg-white rounded-lg shadow-md p-6">
      <a
        href="/terms"
        class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium"
      >
        Cancelar
      </a>

      <button
        type="submit"
        :disabled="saving"
        :class="saving ? 'bg-gray-400 cursor-not-allowed' : 'bg-forest-600 hover:bg-forest-700'"
        class="px-8 py-3 text-white rounded-lg transition-colors font-medium flex items-center gap-2"
      >
        <div x-show="saving" class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
        <span x-text="saving ? 'Salvando...' : (isEdit ? 'Atualizar Termo' : 'Criar Termo')"></span>
      </button>
    </div>
  </form>
</div>

  </main>
  <%- include('partials/footer') %>
</body>
</html>
