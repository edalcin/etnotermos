<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | EtnoTermos Admin</title>
  <link href="/assets/styles.css?v=<%= Date.now() %>" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
</head>
<body class="bg-forest-50 min-h-screen flex flex-col">
  <%- include('partials/header') %>
  <main class="flex-grow container mx-auto px-4 py-8">

<div x-data="{
  form: {
    sourceTermId: '',
    targetTermId: '',
    type: ''
  },
  terms: [],
  sourceSearch: '',
  targetSearch: '',
  filteredSourceTerms: [],
  filteredTargetTerms: [],
  selectedSourceTerm: null,
  selectedTargetTerm: null,
  showSourceDropdown: false,
  showTargetDropdown: false,
  activeTooltip: null,
  toggleTooltip(id) {
    this.activeTooltip = this.activeTooltip === id ? null : id;
  },
  relationshipTypes: [
    { category: 'Equivalência', types: [
      { code: 'USE', description: 'Aponta de termo não-preferido para termo preferido' },
      { code: 'UF', description: 'Usado Para - aponta de termo preferido para não-preferidos' }
    ]},
    { category: 'Hierárquico', types: [
      { code: 'BT', description: 'Termo Genérico - hierárquico genérico' },
      { code: 'NT', description: 'Termo Específico - hierárquico genérico' },
      { code: 'BTG', description: 'Termo Genérico Genérico - genérico-específico' },
      { code: 'NTG', description: 'Termo Específico Genérico - específico-genérico' },
      { code: 'BTP', description: 'Termo Genérico Partitivo - todo-parte' },
      { code: 'NTP', description: 'Termo Específico Partitivo - parte-todo' },
      { code: 'BTI', description: 'Termo Genérico de Instância - classe-instância' },
      { code: 'NTI', description: 'Termo Específico de Instância - instância-classe' }
    ]},
    { category: 'Associativo', types: [
      { code: 'RT', description: 'Termo Relacionado - conexão associativa' }
    ]}
  ],
  loading: true,
  saving: false,
  async init() {
    await this.loadTerms();
    this.loading = false;
  },
  async loadTerms() {
    try {
      const response = await fetch('/api/v1/admin/terms?limit=1000');
      const data = await response.json();
      this.terms = data.data || [];
    } catch (error) {
      console.error('Error loading terms:', error);
      alert('Erro ao carregar termos.');
    }
  },
  filterSourceTerms() {
    if (!this.sourceSearch.trim()) {
      this.filteredSourceTerms = [];
      return;
    }
    const search = this.sourceSearch.toLowerCase();
    this.filteredSourceTerms = this.terms
      .filter(t => t.prefLabel.toLowerCase().includes(search))
      .slice(0, 50);
  },
  filterTargetTerms() {
    if (!this.targetSearch.trim()) {
      this.filteredTargetTerms = [];
      return;
    }
    const search = this.targetSearch.toLowerCase();
    this.filteredTargetTerms = this.terms
      .filter(t => t.prefLabel.toLowerCase().includes(search))
      .slice(0, 50);
  },
  selectSourceTerm(term) {
    this.selectedSourceTerm = term;
    this.form.sourceTermId = term._id;
    this.sourceSearch = '';
    this.showSourceDropdown = false;
    this.filteredSourceTerms = [];
  },
  selectTargetTerm(term) {
    this.selectedTargetTerm = term;
    this.form.targetTermId = term._id;
    this.targetSearch = '';
    this.showTargetDropdown = false;
    this.filteredTargetTerms = [];
  },
  clearSourceTerm() {
    this.selectedSourceTerm = null;
    this.form.sourceTermId = '';
  },
  clearTargetTerm() {
    this.selectedTargetTerm = null;
    this.form.targetTermId = '';
  },
  async saveRelationship() {
    // Validation
    if (!this.form.sourceTermId) {
      alert('Selecione o termo de origem.');
      return;
    }
    if (!this.form.targetTermId) {
      alert('Selecione o termo de destino.');
      return;
    }
    if (!this.form.type) {
      alert('Selecione o tipo de relacionamento.');
      return;
    }
    if (this.form.sourceTermId === this.form.targetTermId) {
      alert('Um termo não pode ter relacionamento consigo mesmo.');
      return;
    }

    this.saving = true;
    try {
      const response = await fetch('/api/v1/admin/relationships', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(this.form)
      });

      if (response.ok) {
        alert('Relacionamento criado com sucesso!');
        window.location.href = '/relationships';
      } else {
        const error = await response.json();
        let errorMessage = 'Erro desconhecido';

        if (typeof error.error === 'string') {
          errorMessage = error.error;
          if (error.missing && Array.isArray(error.missing)) {
            errorMessage += ': ' + error.missing.join(', ');
          }
        } else if (error.error && error.error.message) {
          errorMessage = error.error.message;
        } else if (error.message) {
          errorMessage = error.message;
        }

        alert('Erro ao criar relacionamento: ' + errorMessage);
      }
    } catch (error) {
      console.error('Error creating relationship:', error);
      alert('Erro ao criar relacionamento.');
    } finally {
      this.saving = false;
    }
  }
}">

  <!-- Loading State -->
  <div x-show="loading" class="flex justify-center items-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-forest-600"></div>
    <span class="ml-3 text-gray-600">Carregando...</span>
  </div>

  <!-- Form -->
  <div x-show="!loading">
    <!-- Header -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <h1 class="text-3xl font-bold text-forest-700">Criar Relacionamento</h1>
        <a href="/relationships" class="text-gray-600 hover:text-gray-800">← Voltar</a>
      </div>
    </div>

    <!-- Info Box -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
      <p class="text-sm text-blue-800">
        <strong>Nota:</strong> Ao criar um relacionamento, o relacionamento recíproco será automaticamente criado pelo sistema.
        Por exemplo, ao criar uma relação BT (Broader Term), a relação NT (Narrower Term) será criada automaticamente.
      </p>
    </div>

    <!-- Form Card -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <!-- Term Selection Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Source Term -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
            Termo de Origem *
            <div class="relative inline-block">
              <button
                type="button"
                @click.stop="toggleTooltip('sourceTerm')"
                class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
              >
                <span class="text-xs font-bold">i</span>
              </button>
              <div
                x-show="activeTooltip === 'sourceTerm'"
                @click.away="activeTooltip = null"
                class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
                style="display: none;"
              >
                <h4 class="font-semibold text-gray-900 mb-1">Termo de Origem</h4>
                <p class="text-gray-700 mb-2">
                  Ponto de partida do relacionamento. Para relacionamentos hierárquicos (BT/NT), este é o termo subordinado. Para equivalências (USE), este é o termo não-preferido.
                </p>
                <p class="text-xs text-gray-600 italic">
                  <strong>Exemplo BT:</strong> "Raízes Medicinais" (origem) → "Plantas Medicinais" (destino)
                </p>
              </div>
            </div>
          </label>

          <!-- Selected Term Display -->
          <div x-show="selectedSourceTerm" class="mb-2">
            <div class="bg-forest-50 border border-forest-200 rounded-lg p-3 flex items-center justify-between">
              <div>
                <span class="text-sm font-medium text-forest-700" x-text="selectedSourceTerm?.prefLabel"></span>
                <span class="text-xs text-gray-500 ml-2" x-text="'(' + selectedSourceTerm?._id + ')'"></span>
              </div>
              <button
                type="button"
                @click="clearSourceTerm()"
                class="text-red-600 hover:text-red-800 text-sm"
              >
                ✕ Limpar
              </button>
            </div>
          </div>

          <!-- Autocomplete Input -->
          <div x-show="!selectedSourceTerm" class="relative">
            <input
              type="text"
              x-model="sourceSearch"
              @input="filterSourceTerms(); showSourceDropdown = true"
              @focus="showSourceDropdown = true"
              @blur="setTimeout(() => showSourceDropdown = false, 200)"
              placeholder="Digite para buscar um termo..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            />

            <!-- Dropdown -->
            <div
              x-show="showSourceDropdown && filteredSourceTerms.length > 0"
              class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"
            >
              <template x-for="term in filteredSourceTerms" :key="term._id">
                <button
                  type="button"
                  @click="selectSourceTerm(term)"
                  class="w-full px-4 py-2 text-left hover:bg-forest-50 border-b border-gray-100 last:border-b-0"
                >
                  <div class="font-medium text-gray-800" x-text="term.prefLabel"></div>
                  <div class="text-xs text-gray-500" x-text="term.definition?.substring(0, 100) || 'Sem definição'"></div>
                </button>
              </template>
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-1">Total de termos: <span x-text="terms.length"></span></p>
        </div>

        <!-- Target Term -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
            Termo de Destino *
            <div class="relative inline-block">
              <button
                type="button"
                @click.stop="toggleTooltip('targetTerm')"
                class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
              >
                <span class="text-xs font-bold">i</span>
              </button>
              <div
                x-show="activeTooltip === 'targetTerm'"
                @click.away="activeTooltip = null"
                class="absolute z-50 w-80 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl right-0"
                style="display: none;"
              >
                <h4 class="font-semibold text-gray-900 mb-1">Termo de Destino</h4>
                <p class="text-gray-700 mb-2">
                  Ponto de chegada do relacionamento. Para hierarquias (BT/NT), este é o termo superior. Para equivalências (USE), este é o termo preferido. O sistema criará automaticamente o relacionamento recíproco.
                </p>
                <p class="text-xs text-gray-600 italic">
                  <strong>Exemplo USE:</strong> "Mandioca" (origem) → "Cassava" (destino, preferido)
                </p>
              </div>
            </div>
          </label>

          <!-- Selected Term Display -->
          <div x-show="selectedTargetTerm" class="mb-2">
            <div class="bg-forest-50 border border-forest-200 rounded-lg p-3 flex items-center justify-between">
              <div>
                <span class="text-sm font-medium text-forest-700" x-text="selectedTargetTerm?.prefLabel"></span>
                <span class="text-xs text-gray-500 ml-2" x-text="'(' + selectedTargetTerm?._id + ')'"></span>
              </div>
              <button
                type="button"
                @click="clearTargetTerm()"
                class="text-red-600 hover:text-red-800 text-sm"
              >
                ✕ Limpar
              </button>
            </div>
          </div>

          <!-- Autocomplete Input -->
          <div x-show="!selectedTargetTerm" class="relative">
            <input
              type="text"
              x-model="targetSearch"
              @input="filterTargetTerms(); showTargetDropdown = true"
              @focus="showTargetDropdown = true"
              @blur="setTimeout(() => showTargetDropdown = false, 200)"
              placeholder="Digite para buscar um termo..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
            />

            <!-- Dropdown -->
            <div
              x-show="showTargetDropdown && filteredTargetTerms.length > 0"
              class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"
            >
              <template x-for="term in filteredTargetTerms" :key="term._id">
                <button
                  type="button"
                  @click="selectTargetTerm(term)"
                  class="w-full px-4 py-2 text-left hover:bg-forest-50 border-b border-gray-100 last:border-b-0"
                >
                  <div class="font-medium text-gray-800" x-text="term.prefLabel"></div>
                  <div class="text-xs text-gray-500" x-text="term.definition?.substring(0, 100) || 'Sem definição'"></div>
                </button>
              </template>
            </div>
          </div>

          <p class="text-xs text-gray-500 mt-1">Total de termos: <span x-text="terms.length"></span></p>
        </div>
      </div>

      <!-- Relationship Type -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
          Tipo de Relacionamento *
          <div class="relative inline-block">
            <button
              type="button"
              @click.stop="toggleTooltip('relType')"
              class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors cursor-help"
            >
              <span class="text-xs font-bold">i</span>
            </button>
            <div
              x-show="activeTooltip === 'relType'"
              @click.away="activeTooltip = null"
              class="absolute z-50 w-96 p-3 mt-2 text-sm bg-white border border-gray-200 rounded-lg shadow-xl left-0"
              style="display: none;"
            >
              <h4 class="font-semibold text-gray-900 mb-2">Tipos de Relacionamento (Z39.19)</h4>
              <div class="space-y-2 text-gray-700">
                <p><strong>Equivalência:</strong> USE/UF ligam termos preferidos e não-preferidos</p>
                <p><strong>Hierárquicos:</strong> BT/NT (genérico), BTG/NTG (tipo), BTP/NTP (parte), BTI/NTI (instância)</p>
                <p><strong>Associativo:</strong> RT conecta termos relacionados sem hierarquia</p>
              </div>
              <p class="text-xs text-gray-600 italic mt-2">
                <strong>Exemplo:</strong> "Cannabis" BT "Plantas Medicinais" (Cannabis é tipo de Planta Medicinal)
              </p>
            </div>
          </div>
        </label>
        <select
          x-model="form.type"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
        >
          <option value="">Selecione um tipo...</option>
          <template x-for="category in relationshipTypes" :key="category.category">
            <optgroup :label="category.category">
              <template x-for="type in category.types" :key="type.code">
                <option :value="type.code" x-text="type.code + ' - ' + type.description"></option>
              </template>
            </optgroup>
          </template>
        </select>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-4">
        <button
          type="button"
          @click="saveRelationship()"
          :disabled="saving"
          class="px-6 py-3 bg-forest-600 text-white rounded-lg hover:bg-forest-700 transition-colors font-medium disabled:bg-gray-400 disabled:cursor-not-allowed"
        >
          <span x-show="!saving">Criar Relacionamento</span>
          <span x-show="saving">Salvando...</span>
        </button>
        <a
          href="/relationships"
          class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors inline-block"
        >
          Cancelar
        </a>
      </div>
    </div>
  </div>

</div>

  </main>
  <%- include('partials/footer') %>
</body>
</html>
