<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | EtnoTermos Admin</title>
  <link href="/assets/styles.css?v=<%= Date.now() %>" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
</head>
<body class="bg-forest-50 min-h-screen flex flex-col">
  <%- include('partials/header') %>
  <main class="flex-grow container mx-auto px-4 py-8">

<div x-data="{
  // Data
  terms: [],
  expandedTerms: {},
  loadingRelationships: {},
  relationshipsData: {},

  // Modal state
  selectedRelationship: null,
  showRelModal: false,

  // Pagination
  currentPage: 1,
  itemsPerPage: 20,
  totalTerms: 0,
  totalPages: 1,

  // Filters and search
  loading: true,
  searchQuery: '',
  statusFilter: new URLSearchParams(window.location.search).get('status') || '',
  collectionFilter: new URLSearchParams(window.location.search).get('collection') || '',
  filterMode: new URLSearchParams(window.location.search).get('filter') || '',
  collectionName: '',

  // Initialize
  async init() {
    if (this.collectionFilter) {
      await this.loadCollectionName();
    }
    await this.loadTerms();
  },

  // Load collection name for filter badge
  async loadCollectionName() {
    try {
      const response = await fetch(`/api/v1/collections/${this.collectionFilter}`);
      const collection = await response.json();
      this.collectionName = collection.name;
    } catch (error) {
      console.error('Error loading collection name:', error);
    }
  },

  // Load terms with pagination
  async loadTerms() {
    this.loading = true;
    try {
      let endpoint = '/api/v1/admin/terms';
      const params = new URLSearchParams({
        page: this.currentPage,
        limit: this.itemsPerPage,
        includeCounts: 'true',
        ...(this.searchQuery && { q: this.searchQuery }),
        ...(this.statusFilter && { status: this.statusFilter }),
        ...(this.collectionFilter && { collections: this.collectionFilter })
      });

      // Handle special filter modes
      if (this.filterMode === 'orphans') {
        endpoint = '/api/v1/admin/terms/orphans';
      }

      const response = await fetch(`${endpoint}?${params}`);
      const data = await response.json();

      this.terms = data.data || [];
      this.totalTerms = data.pagination?.total || 0;
      this.totalPages = data.pagination?.totalPages || 1;
    } catch (error) {
      console.error('Error loading terms:', error);
    } finally {
      this.loading = false;
    }
  },

  // Toggle term expansion
  async toggleExpand(termId) {
    if (this.expandedTerms[termId]) {
      this.expandedTerms[termId] = false;
    } else {
      this.expandedTerms[termId] = true;
      // Load relationships if not already loaded
      if (!this.relationshipsData[termId]) {
        await this.loadRelationships(termId);
      }
    }
  },

  // Load relationships for a term
  async loadRelationships(termId) {
    this.loadingRelationships[termId] = true;
    try {
      const response = await fetch(`/api/v1/admin/terms/${termId}/relationships`);
      const data = await response.json();
      this.relationshipsData[termId] = data;
    } catch (error) {
      console.error('Error loading relationships:', error);
    } finally {
      this.loadingRelationships[termId] = false;
    }
  },

  // Check if term is expanded
  isExpanded(termId) {
    return this.expandedTerms[termId] === true;
  },

  // Check if term has any relationships
  hasRelationships(term) {
    if (!term.relationshipCounts) return false;
    const counts = term.relationshipCounts;
    return (counts.BT + counts.NT + counts.RT + counts.USE + counts.UF) > 0;
  },

  // Get total relationship count
  getTotalRelCount(term) {
    if (!term.relationshipCounts) return 0;
    const counts = term.relationshipCounts;
    return counts.BT + counts.NT + counts.RT + counts.USE + counts.UF;
  },

  // Get relationship categories that have data
  getRelationshipCategories(termId) {
    const data = this.relationshipsData[termId];
    if (!data) return [];

    const categories = [];

    // Hierarchical
    const hierCount = Object.values(data.hierarchical || {}).flat().length;
    if (hierCount > 0) {
      categories.push({
        name: 'Hierarquicos',
        bgColor: 'bg-blue-50',
        borderColor: 'border-blue-200',
        types: data.hierarchical
      });
    }

    // Associative
    const assocCount = Object.values(data.associative || {}).flat().length;
    if (assocCount > 0) {
      categories.push({
        name: 'Associativos',
        bgColor: 'bg-gray-50',
        borderColor: 'border-gray-200',
        types: data.associative
      });
    }

    // Equivalence
    const equivCount = Object.values(data.equivalence || {}).flat().length;
    if (equivCount > 0) {
      categories.push({
        name: 'Equivalencia',
        bgColor: 'bg-green-50',
        borderColor: 'border-green-200',
        types: data.equivalence
      });
    }

    return categories;
  },

  // Open relationship modal
  openRelationshipModal(rel) {
    this.selectedRelationship = rel;
    this.showRelModal = true;
    document.body.style.overflow = 'hidden';
  },

  // Close relationship modal
  closeRelModal() {
    this.showRelModal = false;
    this.selectedRelationship = null;
    document.body.style.overflow = '';
  },

  // Delete a relationship
  async deleteRelationship(relId, termId) {
    if (!confirm('Tem certeza que deseja remover este relacionamento?')) return;

    try {
      const response = await fetch(`/api/v1/admin/relationships/${relId}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        this.closeRelModal();
        // Reload relationships for this term
        delete this.relationshipsData[termId];
        await this.loadRelationships(termId);
        // Reload terms to update counts
        await this.loadTerms();
      } else {
        alert('Erro ao remover relacionamento.');
      }
    } catch (error) {
      console.error('Error deleting relationship:', error);
      alert('Erro ao remover relacionamento.');
    }
  },

  // Pagination
  nextPage() {
    if (this.currentPage < this.totalPages) {
      this.currentPage++;
      this.loadTerms();
    }
  },

  prevPage() {
    if (this.currentPage > 1) {
      this.currentPage--;
      this.loadTerms();
    }
  },

  goToPage(page) {
    if (page >= 1 && page <= this.totalPages) {
      this.currentPage = page;
      this.loadTerms();
    }
  },

  // Search and filter
  search() {
    this.currentPage = 1;
    this.loadTerms();
  },

  clearFilters() {
    window.location.href = '/terms';
  },

  // Status badge class
  getStatusClass(status) {
    switch(status) {
      case 'active': return 'bg-green-100 text-green-800';
      case 'candidate': return 'bg-yellow-100 text-yellow-800';
      case 'deprecated': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  },

  // Relationship type label
  getTypeLabel(type) {
    const labels = {
      'BT': 'Termo Mais Amplo',
      'BTG': 'Termo Mais Amplo (Generico)',
      'BTP': 'Termo Mais Amplo (Partitivo)',
      'BTI': 'Termo Mais Amplo (Instancia)',
      'NT': 'Termo Mais Especifico',
      'NTG': 'Termo Mais Especifico (Generico)',
      'NTP': 'Termo Mais Especifico (Partitivo)',
      'NTI': 'Termo Mais Especifico (Instancia)',
      'RT': 'Termo Relacionado',
      'USE': 'Use',
      'UF': 'Usado Para'
    };
    return labels[type] || type;
  }
}">

  <!-- Header and Actions -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold text-forest-700">Gerenciar Termos</h1>
      <p class="text-gray-600 mt-1">
        <template x-if="filterMode === 'orphans'">
          <span>Termos sem relacionamentos</span>
        </template>
        <template x-if="filterMode !== 'orphans'">
          <span>Lista paginada de todos os termos com relacionamentos</span>
        </template>
      </p>
      <!-- Active Filters -->
      <div class="flex gap-2 mt-2">
        <template x-if="filterMode">
          <span class="inline-flex items-center gap-2 px-3 py-1 bg-forest-100 text-forest-700 rounded-full text-sm font-medium">
            <span x-text="filterMode === 'orphans' ? 'Orfaos' : 'Por Status'"></span>
            <button @click="clearFilters()" class="hover:text-forest-900" title="Remover filtro">x</button>
          </span>
        </template>
        <template x-if="collectionFilter">
          <span class="inline-flex items-center gap-2 px-3 py-1 bg-forest-100 text-forest-700 rounded-full text-sm font-medium">
            <span>Colecao: <strong x-text="collectionName"></strong></span>
            <button @click="clearFilters()" class="hover:text-forest-900" title="Remover filtro">x</button>
          </span>
        </template>
      </div>
    </div>
    <a
      href="/terms/new"
      class="px-6 py-3 bg-forest-600 text-white rounded-lg hover:bg-forest-700 transition-colors font-medium"
    >
      + Novo Termo
    </a>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
        <input
          type="text"
          x-model="searchQuery"
          @keyup.enter="search()"
          placeholder="Digite para buscar..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
        >
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
        <select
          x-model="statusFilter"
          @change="search()"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-forest-600"
        >
          <option value="">Todos</option>
          <option value="active">Ativo</option>
          <option value="candidate">Candidato</option>
          <option value="deprecated">Depreciado</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div x-show="loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-forest-600"></div>
    <p class="text-gray-600 mt-4">Carregando termos...</p>
  </div>

  <!-- Terms List -->
  <div x-show="!loading" class="bg-white rounded-lg shadow-md overflow-hidden">
    <!-- Empty state -->
    <div x-show="terms.length === 0" class="text-center py-12 text-gray-600">
      Nenhum termo encontrado
    </div>

    <!-- List -->
    <div x-show="terms.length > 0" class="divide-y divide-gray-200">
      <template x-for="term in terms" :key="term._id">
        <div class="border-b border-gray-100 last:border-b-0">
          <!-- Term Row -->
          <div
            class="flex items-center py-3 px-4 hover:bg-forest-50 transition-colors group"
          >
            <!-- Expand/collapse button -->
            <button
              @click="toggleExpand(term._id)"
              class="mr-3 w-8 h-8 flex items-center justify-center hover:bg-forest-100 rounded transition-colors flex-shrink-0"
              :class="{ 'opacity-50 cursor-not-allowed': !hasRelationships(term) }"
              :disabled="!hasRelationships(term)"
            >
              <svg
                class="w-5 h-5 text-gray-600 transition-transform"
                :class="{ 'rotate-90': isExpanded(term._id) }"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>

            <!-- Term content -->
            <div class="flex-grow min-w-0">
              <div class="flex items-center gap-3 flex-wrap">
                <span class="font-medium text-gray-800" x-text="term.prefLabel"></span>

                <!-- Status badge -->
                <span
                  :class="getStatusClass(term.status)"
                  class="px-2 py-0.5 text-xs rounded-full"
                  x-text="term.status"
                ></span>

                <!-- Relationship count badges -->
                <template x-if="term.relationshipCounts">
                  <div class="flex gap-1">
                    <template x-if="term.relationshipCounts.BT > 0">
                      <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full" x-text="term.relationshipCounts.BT + ' BT'"></span>
                    </template>
                    <template x-if="term.relationshipCounts.NT > 0">
                      <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full" x-text="term.relationshipCounts.NT + ' NT'"></span>
                    </template>
                    <template x-if="term.relationshipCounts.RT > 0">
                      <span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-700 rounded-full" x-text="term.relationshipCounts.RT + ' RT'"></span>
                    </template>
                    <template x-if="term.relationshipCounts.USE > 0">
                      <span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full" x-text="term.relationshipCounts.USE + ' USE'"></span>
                    </template>
                    <template x-if="term.relationshipCounts.UF > 0">
                      <span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full" x-text="term.relationshipCounts.UF + ' UF'"></span>
                    </template>
                  </div>
                </template>
              </div>

              <!-- Definition preview -->
              <div
                x-show="term.definition"
                class="text-sm text-gray-600 truncate mt-1"
                x-text="term.definition"
              ></div>
            </div>

            <!-- Actions -->
            <div class="flex items-center gap-2 ml-4 flex-shrink-0">
              <a
                :href="`/terms/${term._id}/edit`"
                class="px-3 py-1 bg-forest-100 text-forest-700 rounded hover:bg-forest-200 text-sm font-medium"
              >
                Editar
              </a>
            </div>
          </div>

          <!-- Relationships Section (expanded) -->
          <div
            x-show="isExpanded(term._id)"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            class="px-4 pb-4 bg-gray-50"
          >
            <!-- Loading relationships -->
            <div x-show="loadingRelationships[term._id]" class="py-4 text-center">
              <div class="inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-forest-600"></div>
              <p class="text-sm text-gray-500 mt-2">Carregando relacionamentos...</p>
            </div>

            <!-- Relationship categories -->
            <div x-show="!loadingRelationships[term._id] && relationshipsData[term._id]" class="space-y-4 pt-3">
              <template x-for="category in getRelationshipCategories(term._id)" :key="category.name">
                <div :class="[category.bgColor, category.borderColor]" class="rounded-lg p-4 border">
                  <h4 class="font-medium text-gray-700 mb-3 uppercase text-xs tracking-wide" x-text="category.name"></h4>
                  <div class="flex flex-wrap gap-2">
                    <template x-for="(rels, type) in category.types" :key="type">
                      <template x-for="rel in rels" :key="rel._id">
                        <button
                          @click="openRelationshipModal({ ...rel, sourceTermId: term._id })"
                          class="inline-flex items-center gap-2 px-3 py-2 bg-white rounded-lg shadow-sm border border-gray-200 hover:shadow-md hover:border-forest-300 transition-all cursor-pointer text-left"
                        >
                          <span class="text-xs font-bold text-forest-600 uppercase" x-text="rel.type"></span>
                          <span class="text-gray-800" x-text="rel.targetTerm?.prefLabel || 'Termo removido'"></span>
                        </button>
                      </template>
                    </template>
                  </div>
                </div>
              </template>

              <!-- No relationships message -->
              <div x-show="getRelationshipCategories(term._id).length === 0" class="py-4 text-center text-gray-500">
                Nenhum relacionamento encontrado
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <!-- Pagination Controls -->
    <div x-show="totalPages > 1" class="bg-gray-50 px-6 py-4 flex items-center justify-between border-t border-gray-200">
      <div class="text-sm text-gray-600">
        <span>Mostrando </span>
        <span x-text="`${(currentPage - 1) * itemsPerPage + 1}-${Math.min(currentPage * itemsPerPage, totalTerms)}`"></span>
        <span> de </span>
        <span x-text="totalTerms"></span>
        <span> termos</span>
      </div>
      <div class="flex items-center gap-2">
        <button
          @click="prevPage()"
          :disabled="currentPage <= 1"
          :class="currentPage <= 1 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'"
          class="px-4 py-2 border border-gray-300 rounded-lg transition-colors font-medium"
        >
          Anterior
        </button>

        <!-- Page numbers -->
        <template x-for="pageNum in Array.from({length: totalPages}, (_, i) => i + 1).filter(p => p === 1 || p === totalPages || (p >= currentPage - 1 && p <= currentPage + 1))" :key="pageNum">
          <button
            @click="goToPage(pageNum)"
            :class="{
              'bg-forest-600 text-white': pageNum === currentPage,
              'bg-white text-gray-700 hover:bg-gray-50': pageNum !== currentPage
            }"
            class="px-4 py-2 border border-gray-300 rounded-lg transition-colors font-medium"
            x-text="pageNum"
          ></button>
        </template>

        <button
          @click="nextPage()"
          :disabled="currentPage >= totalPages"
          :class="currentPage >= totalPages ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white text-gray-700 hover:bg-gray-50'"
          class="px-4 py-2 border border-gray-300 rounded-lg transition-colors font-medium"
        >
          Proximo
        </button>
      </div>
    </div>
  </div>

  <!-- Relationship Details Modal -->
  <div
    x-show="showRelModal"
    @keydown.escape.window="closeRelModal()"
    class="fixed inset-0 z-50 overflow-y-auto"
    style="display: none;"
  >
    <!-- Backdrop -->
    <div
      class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"
      @click="closeRelModal()"
    ></div>

    <!-- Modal Content -->
    <div class="flex items-center justify-center min-h-screen p-4">
      <div
        class="relative bg-white rounded-lg shadow-xl max-w-lg w-full"
        @click.stop
      >
        <!-- Header -->
        <div class="bg-forest-600 text-white px-6 py-4 rounded-t-lg flex items-center justify-between">
          <h2 class="text-xl font-bold">Detalhes do Relacionamento</h2>
          <button
            @click="closeRelModal()"
            class="text-white hover:text-forest-100 transition-colors"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Body -->
        <div class="p-6">
          <template x-if="selectedRelationship">
            <div class="space-y-4">
              <div>
                <label class="text-sm font-medium text-gray-600">Tipo de Relacionamento</label>
                <div class="flex items-center gap-2 mt-1">
                  <span class="px-3 py-1 bg-forest-100 text-forest-700 rounded-full font-bold" x-text="selectedRelationship.type"></span>
                  <span class="text-gray-600" x-text="getTypeLabel(selectedRelationship.type)"></span>
                </div>
              </div>

              <div>
                <label class="text-sm font-medium text-gray-600">Termo Destino</label>
                <p class="text-lg text-gray-900 mt-1" x-text="selectedRelationship.targetTerm?.prefLabel || 'Termo nao encontrado'"></p>
              </div>

              <template x-if="selectedRelationship.targetTerm?.definition">
                <div>
                  <label class="text-sm font-medium text-gray-600">Definicao</label>
                  <p class="text-gray-700 mt-1" x-text="selectedRelationship.targetTerm.definition"></p>
                </div>
              </template>

              <template x-if="selectedRelationship.targetTerm?.status">
                <div>
                  <label class="text-sm font-medium text-gray-600">Status</label>
                  <div class="mt-1">
                    <span
                      :class="getStatusClass(selectedRelationship.targetTerm.status)"
                      class="px-2 py-1 text-sm rounded-full"
                      x-text="selectedRelationship.targetTerm.status"
                    ></span>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>

        <!-- Footer (Actions) -->
        <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-t border-gray-200 rounded-b-lg">
          <a
            :href="`/terms/${selectedRelationship?.targetTerm?._id}/edit`"
            class="px-4 py-2 bg-forest-600 text-white rounded-lg hover:bg-forest-700 transition-colors font-medium"
          >
            Ver Termo Destino
          </a>

          <button
            @click="deleteRelationship(selectedRelationship._id, selectedRelationship.sourceTermId)"
            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium"
          >
            Remover Relacionamento
          </button>
        </div>
      </div>
    </div>
  </div>

</div>

  </main>
  <%- include('partials/footer') %>
</body>
</html>
